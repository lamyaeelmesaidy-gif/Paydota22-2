name: Build Android APK & AAB

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'

jobs:
  build-android:
    name: Build Android APK & AAB
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}
      
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build web assets
        run: npm run build
      
      - name: Setup keystore from secrets
        env:
          RELEASE_KEYSTORE: ${{ secrets.RELEASE_KEYSTORE }}
        run: |
          if [ -n "$RELEASE_KEYSTORE" ]; then
            echo "$RELEASE_KEYSTORE" > android/app/signing.keystore.base64
            base64 -d android/app/signing.keystore.base64 > android/app/signing.keystore
            echo "KEYSTORE_EXISTS=true" >> $GITHUB_ENV
          elif [ -f "attached_assets/signing_1750726650743.keystore" ]; then
            cp attached_assets/signing_1750726650743.keystore android/app/signing.keystore
            echo "KEYSTORE_EXISTS=true" >> $GITHUB_ENV
            echo "Using existing keystore from attached_assets"
          else
            echo "KEYSTORE_EXISTS=false" >> $GITHUB_ENV
            echo "âš ï¸ No keystore found. Builds will be unsigned."
          fi
      
      - name: Sync Capacitor
        run: npx cap sync android
      
      - name: Make gradlew executable
        run: chmod +x android/gradlew
      
      - name: Build Debug APK
        if: github.event.inputs.build_type == 'debug' || github.event_name == 'pull_request'
        working-directory: android
        run: ./gradlew assembleDebug --stacktrace
      
      - name: Build Release APK
        if: github.event.inputs.build_type != 'debug' && github.event_name != 'pull_request'
        working-directory: android
        run: ./gradlew assembleRelease --stacktrace
      
      - name: Build Release AAB
        if: github.event.inputs.build_type != 'debug' && github.event_name != 'pull_request'
        working-directory: android
        run: ./gradlew bundleRelease --stacktrace
      
      - name: Sign APK with jarsigner
        if: env.KEYSTORE_EXISTS == 'true' && github.event.inputs.build_type != 'debug' && github.event_name != 'pull_request'
        env:
          RELEASE_KEYSTORE_PASSWORD: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
        run: |
          STORE_PASSWORD="${RELEASE_KEYSTORE_PASSWORD:-paydota123}"
          KEY_ALIAS="${RELEASE_KEY_ALIAS:-paydota}"
          KEY_PASSWORD="${RELEASE_KEY_PASSWORD:-$STORE_PASSWORD}"
          
          UNSIGNED_APK="android/app/build/outputs/apk/release/app-release-unsigned.apk"
          if [ ! -f "$UNSIGNED_APK" ]; then
            UNSIGNED_APK=$(find android/app/build/outputs/apk/release -name "*.apk" | head -1)
          fi
          
          if [ -f "$UNSIGNED_APK" ]; then
            jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
              -keystore android/app/signing.keystore \
              -storepass "$STORE_PASSWORD" \
              -keypass "$KEY_PASSWORD" \
              "$UNSIGNED_APK" \
              "$KEY_ALIAS"
            
            echo "âœ… APK signed successfully!"
          fi
      
      - name: Sign AAB with jarsigner
        if: env.KEYSTORE_EXISTS == 'true' && github.event.inputs.build_type != 'debug' && github.event_name != 'pull_request'
        env:
          RELEASE_KEYSTORE_PASSWORD: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
        run: |
          STORE_PASSWORD="${RELEASE_KEYSTORE_PASSWORD:-paydota123}"
          KEY_ALIAS="${RELEASE_KEY_ALIAS:-paydota}"
          KEY_PASSWORD="${RELEASE_KEY_PASSWORD:-$STORE_PASSWORD}"
          
          UNSIGNED_AAB="android/app/build/outputs/bundle/release/app-release.aab"
          SIGNED_AAB="android/app/build/outputs/bundle/release/app-release-signed.aab"
          
          if [ -f "$UNSIGNED_AAB" ]; then
            jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
              -keystore android/app/signing.keystore \
              -storepass "$STORE_PASSWORD" \
              -keypass "$KEY_PASSWORD" \
              -signedjar "$SIGNED_AAB" \
              "$UNSIGNED_AAB" \
              "$KEY_ALIAS"
            
            echo "âœ… AAB signed successfully!"
          fi
      
      - name: Upload Debug APK
        if: github.event.inputs.build_type == 'debug' || github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: paydota-debug-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 14
      
      - name: Upload Release APK
        if: github.event.inputs.build_type != 'debug' && github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: paydota-release-apk
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 30
      
      - name: Upload Release AAB
        if: github.event.inputs.build_type != 'debug' && github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: paydota-release-aab
          path: android/app/build/outputs/bundle/release/*.aab
          retention-days: 30
      
      - name: Clean up keystore
        if: always()
        run: |
          rm -f android/app/signing.keystore.base64
          rm -f android/app/signing.keystore

  create-release:
    name: Create GitHub Release
    needs: build-android
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    
    steps:
      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: paydota-release-apk
          path: ./release
      
      - name: Download AAB artifact
        uses: actions/download-artifact@v4
        with:
          name: paydota-release-aab
          path: ./release
      
      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Rename files
        run: |
          cd release
          for f in *.apk; do
            [ -f "$f" ] && mv "$f" "PayDota-${{ steps.version.outputs.VERSION }}.apk"
          done
          for f in *-signed.aab; do
            [ -f "$f" ] && mv "$f" "PayDota-${{ steps.version.outputs.VERSION }}.aab"
          done
          for f in *.aab; do
            [ -f "$f" ] && [ ! -f "PayDota-${{ steps.version.outputs.VERSION }}.aab" ] && mv "$f" "PayDota-${{ steps.version.outputs.VERSION }}.aab"
          done
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: PayDota ${{ steps.version.outputs.VERSION }}
          body: |
            ## ğŸ‰ PayDota Release ${{ steps.version.outputs.VERSION }}
            
            ### ğŸ“± Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„
            - **APK**: Ù„Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¹Ù„Ù‰ Ø£Ø¬Ù‡Ø²Ø© Android
            - **AAB**: Ù„Ù„Ø±ÙØ¹ Ø¥Ù„Ù‰ Google Play Store
            
            ### âœ… Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª
            - ØªÙ… Ø§Ù„Ø¨Ù†Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ø¨Ø± GitHub Actions
            - APK Ùˆ AAB Ù…ÙˆÙ‚Ø¹ÙŠÙ† ÙˆØ¬Ø§Ù‡Ø²ÙŠÙ† Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
            - keystore Ù„Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¢Ù…Ù†
            
            ### ğŸ“¥ Ø§Ù„ØªØ«Ø¨ÙŠØª
            Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù APK Ø£Ø¯Ù†Ø§Ù‡ ÙˆØªØ«Ø¨ÙŠØªÙ‡ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Android
            
            ### ğŸª Google Play
            Ø§Ø³ØªØ®Ø¯Ù… Ù…Ù„Ù AAB Ù„Ù„Ø±ÙØ¹ Ø¥Ù„Ù‰ Ù…ØªØ¬Ø± Google Play
          files: ./release/*
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  auto-release:
    name: Auto Release on Push
    needs: build-android
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    
    steps:
      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: paydota-release-apk
          path: ./release
      
      - name: Download AAB artifact
        uses: actions/download-artifact@v4
        with:
          name: paydota-release-aab
          path: ./release
      
      - name: Create Auto Release
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ github.run_number }}
          name: PayDota Mobile v${{ github.run_number }}
          body: |
            ğŸ‰ **ØªØ·Ø¨ÙŠÙ‚ PayDota Ø§Ù„Ù…Ø­Ù…ÙˆÙ„ - Ø¥ØµØ¯Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ**
            
            ğŸ“± **Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:**
            - âœ… APK Ù…ÙˆÙ‚Ø¹ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„ØªØ«Ø¨ÙŠØª
            - âœ… AAB Ø¬Ø§Ù‡Ø² Ù„Ù„Ø±ÙØ¹ Ø¥Ù„Ù‰ Google Play Store
            - âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø© Ù…ÙØ¹Ù„Ø©
            - âœ… keystore Ù„Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¢Ù…Ù†
            - âœ… ØªÙ… Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            
            ğŸ“¥ **Ø§Ù„ØªØ«Ø¨ÙŠØª:**
            Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù APK Ø£Ø¯Ù†Ø§Ù‡ ÙˆØªØ«Ø¨ÙŠØªÙ‡ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Android
            
            ğŸª **Google Play:**
            Ø§Ø³ØªØ®Ø¯Ù… Ù…Ù„Ù AAB Ù„Ù„Ø±ÙØ¹ Ø¥Ù„Ù‰ Ù…ØªØ¬Ø± Google Play
            
            ğŸ—ï¸ **Build #${{ github.run_number }}**
          artifacts: "./release/*"
          draft: false
          prerelease: false
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}
